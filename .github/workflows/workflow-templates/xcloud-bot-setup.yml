name: 'ğŸ¤– xCloud Bot Setup'

on:
  workflow_dispatch:
    inputs:
      features:
        description: 'Features to enable (comma-separated)'
        required: false
        default: 'autoReview,geminiIntegration,issueManagement'
        type: string
      bot_repo:
        description: 'xCloud Bot repository'
        required: false
        default: 'PageCloudv1/xcloud-bot'
        type: string

concurrency:
  group: '${{ github.workflow }}-setup'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  setup-xcloud-bot:
    runs-on: 'ubuntu-latest'
    timeout-minutes: 10
    permissions:
      contents: 'write'
      issues: 'write'
      pull-requests: 'write'
      actions: 'write'
    
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Setup xCloud Bot Workflows'
        id: 'setup_workflows'
        env:
          FEATURES: '${{ inputs.features }}'
          BOT_REPO: '${{ inputs.bot_repo }}'
        run: |
          echo "ğŸš€ Configurando xCloud Bot para este repositÃ³rio..."
          
          # Criar diretÃ³rio de workflows se nÃ£o existir
          mkdir -p .github/workflows
          
          # Features solicitadas
          IFS=',' read -ra FEATURE_ARRAY <<< "$FEATURES"
          
          echo "ğŸ“‹ Features solicitadas:"
          for feature in "${FEATURE_ARRAY[@]}"; do
            echo "  - $feature"
          done
          
          # Baixar workflows do repositÃ³rio do bot
          echo "ğŸ“¥ Baixando workflows do xCloud Bot..."
          
          # Auto Copilot Review
          if [[ " ${FEATURE_ARRAY[@]} " =~ " autoReview " ]]; then
            echo "âš™ï¸ Configurando Auto Copilot Review..."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$BOT_REPO/contents/.github/workflows/auto-copilot-review.yml" \
              | jq -r '.content' | base64 -d > .github/workflows/auto-copilot-review.yml
          fi
          
          # Enhanced Gemini CLI
          if [[ " ${FEATURE_ARRAY[@]} " =~ " geminiIntegration " ]]; then
            echo "ğŸ§  Configurando Enhanced Gemini CLI..."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$BOT_REPO/contents/.github/workflows/enhanced-gemini-cli.yml" \
              | jq -r '.content' | base64 -d > .github/workflows/enhanced-gemini-cli.yml
          fi
          
          # Gemini Review
          if [[ " ${FEATURE_ARRAY[@]} " =~ " geminiIntegration " ]]; then
            echo "ğŸ” Configurando Gemini Review..."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$BOT_REPO/contents/.github/workflows/gemini-review.yml" \
              | jq -r '.content' | base64 -d > .github/workflows/gemini-review.yml
          fi
          
          # Issue Management
          if [[ " ${FEATURE_ARRAY[@]} " =~ " issueManagement " ]]; then
            echo "ğŸ“ Configurando Issue Management..."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$BOT_REPO/contents/.github/workflows/gemini-triage.yml" \
              | jq -r '.content' | base64 -d > .github/workflows/gemini-triage.yml
          fi
          
          echo "âœ… Workflows configurados com sucesso!"

      - name: 'Create Bot Configuration'
        run: |
          echo "ğŸ“„ Criando configuraÃ§Ã£o do bot..."
          
          # Criar arquivo de configuraÃ§Ã£o
          mkdir -p .xcloud-bot
          
          cat > .xcloud-bot/config.json << EOF
          {
            "repository": "${{ github.repository }}",
            "features": {
              "autoReview": ${{ contains(inputs.features, 'autoReview') }},
              "geminiIntegration": ${{ contains(inputs.features, 'geminiIntegration') }},
              "issueManagement": ${{ contains(inputs.features, 'issueManagement') }},
              "prAutomation": true,
              "securityScanning": false,
              "performanceMonitoring": false
            },
            "workflows": {
              "auto-copilot-review": ${{ contains(inputs.features, 'autoReview') }},
              "enhanced-gemini-cli": ${{ contains(inputs.features, 'geminiIntegration') }},
              "gemini-review": ${{ contains(inputs.features, 'geminiIntegration') }},
              "gemini-triage": ${{ contains(inputs.features, 'issueManagement') }}
            },
            "setupDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "1.0.0"
          }
          EOF
          
          echo "âœ… ConfiguraÃ§Ã£o criada!"

      - name: 'Create README Section'
        run: |
          echo "ğŸ“š Adicionando seÃ§Ã£o do xCloud Bot ao README..."
          
          # Verificar se README existe
          if [ -f "README.md" ]; then
            # Verificar se jÃ¡ existe seÃ§Ã£o do bot
            if ! grep -q "## ğŸ¤– xCloud Bot" README.md; then
              cat >> README.md << 'EOF'

## ğŸ¤– xCloud Bot

Este repositÃ³rio estÃ¡ integrado com o xCloud Bot para automaÃ§Ã£o e assistÃªncia em desenvolvimento.

### Features Ativas

- âœ… **Auto Review**: Reviews automÃ¡ticos com @Copilot
- ğŸ§  **Gemini Integration**: AnÃ¡lise de cÃ³digo com IA
- ğŸ“ **Issue Management**: Gerenciamento inteligente de issues
- ğŸ”„ **PR Automation**: AutomaÃ§Ã£o de pull requests

### Como Usar

O bot responde automaticamente a:
- Novos issues e pull requests
- ComentÃ¡rios mencionando @Copilot
- Comandos especÃ­ficos nos comentÃ¡rios

### Comandos DisponÃ­veis

- `@Copilot review this` - Solicita review detalhado
- `@Copilot analyze code` - AnÃ¡lise de cÃ³digo
- `@Copilot suggest improvements` - SugestÃµes de melhorias
- `@Copilot security scan` - VerificaÃ§Ã£o de seguranÃ§a

---
*Powered by [xCloud Bot](https://github.com/PageCloudv1/xcloud-bot)*
EOF
              echo "âœ… SeÃ§Ã£o adicionada ao README!"
            else
              echo "â„¹ï¸ SeÃ§Ã£o do xCloud Bot jÃ¡ existe no README"
            fi
          else
            echo "âš ï¸ README.md nÃ£o encontrado, criando..."
            cat > README.md << 'EOF'
# ${{ github.event.repository.name }}

## ğŸ¤– xCloud Bot

Este repositÃ³rio estÃ¡ integrado com o xCloud Bot para automaÃ§Ã£o e assistÃªncia em desenvolvimento.

### Features Ativas

- âœ… **Auto Review**: Reviews automÃ¡ticos com @Copilot
- ğŸ§  **Gemini Integration**: AnÃ¡lise de cÃ³digo com IA
- ğŸ“ **Issue Management**: Gerenciamento inteligente de issues
- ğŸ”„ **PR Automation**: AutomaÃ§Ã£o de pull requests

---
*Powered by [xCloud Bot](https://github.com/PageCloudv1/xcloud-bot)*
EOF
          fi

      - name: 'Commit Changes'
        run: |
          # Configurar git
          git config --local user.email "xcloud-bot@pagecloud.dev"
          git config --local user.name "xCloud Bot"
          
          # Adicionar arquivos
          git add .github/workflows/ .xcloud-bot/ README.md
          
          # Verificar se hÃ¡ mudanÃ§as
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Nenhuma mudanÃ§a para commit"
          else
            # Commit
            git commit -m "ğŸ¤– Setup xCloud Bot integration

Features configuradas:
${{ inputs.features }}

- Workflows adicionados
- ConfiguraÃ§Ã£o criada
- README atualizado

Co-authored-by: xCloud Bot <xcloud-bot@pagecloud.dev>"
            
            # Push
            git push
            
            echo "âœ… MudanÃ§as commitadas e enviadas!"
          fi

      - name: 'Create Welcome Issue'
        uses: 'actions/github-script@v7'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const welcomeMessage = `# ğŸ‰ xCloud Bot Configurado com Sucesso!

OlÃ¡! O xCloud Bot foi configurado neste repositÃ³rio e estÃ¡ pronto para ajudar.

## ğŸš€ Features Ativas

${{ inputs.features }}

## ğŸ¤– Como Usar

O bot agora responderÃ¡ automaticamente a:

- **Novos Issues**: AnÃ¡lise automÃ¡tica e triagem
- **Pull Requests**: Reviews automÃ¡ticos e sugestÃµes
- **ComentÃ¡rios**: Responde a menÃ§Ãµes e comandos

## ğŸ“‹ Comandos DisponÃ­veis

VocÃª pode usar os seguintes comandos nos comentÃ¡rios:

- \`@Copilot review this\` - Solicita review detalhado
- \`@Copilot analyze code\` - AnÃ¡lise de cÃ³digo
- \`@Copilot suggest improvements\` - SugestÃµes de melhorias
- \`@Copilot security scan\` - VerificaÃ§Ã£o de seguranÃ§a

## ğŸ”§ ConfiguraÃ§Ã£o

A configuraÃ§Ã£o do bot estÃ¡ em \`.xcloud-bot/config.json\`. VocÃª pode modificar as features ativas editando este arquivo.

## ğŸ“š DocumentaÃ§Ã£o

Para mais informaÃ§Ãµes, consulte a [documentaÃ§Ã£o completa](https://github.com/PageCloudv1/xcloud-bot).

---

**PrÃ³ximos Passos:**
1. âœ… Bot configurado
2. ğŸ”„ Teste criando um novo issue ou PR
3. ğŸ¯ Personalize as configuraÃ§Ãµes conforme necessÃ¡rio

*Este issue foi criado automaticamente pelo setup do xCloud Bot.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ¤– xCloud Bot - ConfiguraÃ§Ã£o ConcluÃ­da',
              body: welcomeMessage,
              labels: ['xcloud-bot', 'setup', 'documentation']
            });

      - name: 'Summary'
        run: |
          echo "ğŸ‰ xCloud Bot configurado com sucesso!"
          echo ""
          echo "ğŸ“‹ Resumo:"
          echo "  - Features: ${{ inputs.features }}"
          echo "  - Workflows adicionados: âœ…"
          echo "  - ConfiguraÃ§Ã£o criada: âœ…"
          echo "  - README atualizado: âœ…"
          echo "  - Issue de boas-vindas criado: âœ…"
          echo ""
          echo "ğŸš€ O bot estÃ¡ pronto para uso!"