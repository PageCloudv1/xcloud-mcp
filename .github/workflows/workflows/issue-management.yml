name: 'ü§ñ Smart Issue Management - xCloud Team [DISABLED]'

# WORKFLOW DESABILITADO TEMPORARIAMENTE
# Motivo: Conflita com auto-refactor-issues.yml causando spam de mensagens
# Status: Ser√° reativado ap√≥s integra√ß√£o completa dos sistemas

on:
  # issues:
  #   types: [opened, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'N√∫mero da issue para processar'
        required: false
        type: string

concurrency:
  group: '${{ github.workflow }}-${{ github.event_name }}-${{ github.event.issue.number || inputs.issue_number || github.run_id }}'
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  smart-triage:
    name: 'üß† An√°lise Inteligente de Issue'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
      pull-requests: read
    
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Mint GitHub App Token'
        id: 'mint_token'
        if: |-
          ${{ vars.GH_APP_ID }}
        uses: 'actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b'
        with:
          app-id: '${{ vars.GH_APP_ID }}'
          private-key: '${{ secrets.GH_PRIVATE_KEY }}'

      - name: '‚öôÔ∏è Configure Node 20'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'ü§ñ Processar Issue com Gemini + GitHub MCP'
        uses: 'google-github-actions/run-gemini-cli@v0.1.12'  # Pinned version for security
        env:
          TITLE: '${{ github.event.issue.title }}'
          DESCRIPTION: '${{ github.event.issue.body }}'
          ISSUE_NUMBER: '${{ github.event.issue.number || inputs.issue_number }}'
          ISSUE_AUTHOR: '${{ github.event.issue.user.login }}'
          REPOSITORY: '${{ github.repository }}'
          GH_TOKEN: '${{ steps.mint_token.outputs.token || github.token }}'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_model: 'gemini-2.5-flash'
          gemini_debug: true
          settings: |-
            {
              "maxSessionTurns": 15,
              "telemetry": {
                "enabled": false,
                "target": "none"
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server"
                  ],
                  "includeTools": [
                    "add_issue_comment",
                    "get_issue",
                    "get_issue_comments",
                    "list_issues",
                    "search_issues",
                    "update_issue"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GH_TOKEN}"
                  }
                }
              },
              "coreTools": [
                "run_shell_command(echo)",
                "run_shell_command(grep)"
              ]
            }
          prompt: |-
            # ü§ñ xCloud Team - Assistente Inteligente de Issues

            ## Sua Miss√£o
            Voc√™ √© o assistente oficial da **xcloud-team** especializado em an√°lise e triagem inteligente de issues do GitHub.

            ## Dados da Issue Atual
            - **T√≠tulo**: ${TITLE}
            - **Descri√ß√£o**: ${DESCRIPTION}
            - **N√∫mero**: #${ISSUE_NUMBER}
            - **Autor**: ${ISSUE_AUTHOR}
            - **Reposit√≥rio**: ${REPOSITORY}

            ## Processo de An√°lise (Execute TODOS os passos)

            ### 1. üîç **Pesquisa de Duplicatas**
            Use `mcp__github__search_issues` para procurar issues similares:
            - Procure por palavras-chave do t√≠tulo
            - Verifique issues fechadas recentemente
            - Se encontrar duplicata, comente na issue mencionando a issue original

            ### 2. üè∑Ô∏è **Classifica√ß√£o e Labels**
            Analise o conte√∫do e aplique labels apropriados usando `mcp__github__update_issue`:

            **Labels T√©cnicos:**
            - `bug` - Relat√≥rios de erro
            - `feature` - Solicita√ß√µes de funcionalidade
            - `enhancement` - Melhorias
            - `documentation` - Documenta√ß√£o
            - `question` - Perguntas/d√∫vidas
            - `security` - Quest√µes de seguran√ßa
            - `performance` - Problemas de performance

            **Labels de Prioridade:**
            - `priority:high` - Cr√≠tico/urgente
            - `priority:medium` - Importante
            - `priority:low` - Baixa prioridade

            **Labels de Categoria:**
            - `category:api` - Relacionado √† API
            - `category:ui` - Interface de usu√°rio
            - `category:infrastructure` - Infraestrutura
            - `category:workflow` - Workflows/CI-CD
            - `category:bot` - Funcionalidades do bot

            ### 3. üë• **Assignment Autom√°tico**
            Use `mcp__github__update_issue` para:
            - Garantir que `assignees` inclua `xcloud-bot`
            - Selecione um membro dispon√≠vel da equipe `PageCloudv1/xcloud-team`
            - Para issues cr√≠ticas de seguran√ßa, mencione a equipe adicionando o sinal de arroba manualmente (`PageCloudv1/xcloud-team`) e garanta acompanhamento imediato

            ### 4. üí¨ **Resposta Inteligente**
            Use `mcp__github__add_issue_comment` para adicionar um coment√°rio estruturado:

            ```markdown
            ## ü§ñ An√°lise Autom√°tica - xCloud Team

            ### üìã **Classifica√ß√£o**
            - **Tipo**: [bug/feature/enhancement/question/etc]
            - **Prioridade**: [high/medium/low]
            - **Categoria**: [api/ui/infrastructure/etc]

            ### üîç **Status de Duplicatas**
            - [‚úÖ N√£o encontradas duplicatas] OU [‚ö†Ô∏è Poss√≠vel duplicata: #123]

            ### üìù **An√°lise T√©cnica**
            [Sua an√°lise do conte√∫do da issue - seja espec√≠fico e √∫til]

            ### üéØ **Pr√≥ximos Passos Recomendados**
            1. [A√ß√£o espec√≠fica 1]
            2. [A√ß√£o espec√≠fica 2]
            3. [Se aplic√°vel, men√ß√£o a recursos ou documenta√ß√£o relevante]

            ### üë• **Assignments**
            - **Owners**: inclua men√ß√µes para PageCloudv1/xcloud-team e xcloud-bot[bot] (use o caractere arroba na resposta final)
            - **Aten√ß√£o Extra**: mencione a equipe PageCloudv1/xcloud-team em casos cr√≠ticos/seguran√ßa (use arroba ao comentar)

            ---
            ü§ñ *Processado automaticamente pelo xCloud Bot | D√∫vidas? Marque a equipe PageCloudv1/xcloud-team (com arroba na resposta)*
            ```

            ## ‚ö†Ô∏è Regras Importantes
            1. **SEMPRE** pesquise duplicatas antes de processar
            2. **SEMPRE** aplique pelo menos 2 labels (tipo + prioridade)
            3. **SEMPRE** mantenha `xcloud-bot` entre os assignees
            4. **SEMPRE** adicione um coment√°rio explicativo
            5. Se a issue for de **seguran√ßa** ou **cr√≠tica**, acione a equipe PageCloudv1/xcloud-team imediatamente (lembre de usar arroba na resposta final)
            6. Seja **espec√≠fico** e **√∫til** nos coment√°rios
            7. Use linguagem **profissional** mas **acess√≠vel**

            ## üöÄ Comece Agora
            Execute o processo completo de an√°lise para a issue #${ISSUE_NUMBER}.
